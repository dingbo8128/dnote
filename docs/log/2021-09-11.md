---
title: 每天都有解决不完的问题：2021年9月11日
date: 2021-09-11 07:06:20

  - log
  - git
  - mongodb
categories: log
---

## git pull 出错

error: cannot lock ref 'refs/remotes/origin/master'
原因：远程分支被强制 push
方法：先更新本地仓库远程分支的 git update-ref， 再 pull

## 快速搜索命令行日志

<kbd>control</kbd> + <kbd>R </kbd>

## mongodb 实现访问量统计

```js
async function getVisitCount(request: VercelRequest, response: VercelResponse) {
  const { db, client }: DBConn = await connectToDatabase();
  const { pageId } = request.query;
  const collection = db.collection("visitcount");
  const session = client.startSession();
  try {
    await session.withTransaction(async () => {
      const doc = await collection.findOne({ pageId: pageId });
      if (doc === null) {
        response.send({ count: 1 });
        await collection.insertOne({ pageId: pageId, count: 1 });
      } else {
        const newCount = doc.count + 1;
        response.send({ count: newCount });
        await collection.updateOne(
          { pageId: pageId },
          { $set: { count: newCount } }
        );
      }
    });
  } finally {
    await session.endSession();
  }
}
```

## 参考

https://www.mongodb.com/developer/quickstart/node-transactions/
